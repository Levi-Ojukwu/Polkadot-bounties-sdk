{"version":3,"file":"track-tx.mjs","sources":["../../../src/chainHead/track-tx.ts"],"sourcesContent":["import {\n  Observable,\n  distinct,\n  filter,\n  map,\n  mergeMap,\n  of,\n  take,\n  takeUntil,\n} from \"rxjs\"\nimport { PinnedBlocks } from \"./streams\"\nimport { HexString, ResultPayload } from \"@polkadot-api/substrate-bindings\"\n\nexport type AnalyzedBlock = {\n  hash: HexString\n  found:\n    | {\n        type: true\n        index: number\n        events: any\n      }\n    | {\n        type: false\n        validity: ResultPayload<any, any> | null // null means that the block was already present when the tx was broadcasted\n      }\n}\n\nexport const getTrackTx = (\n  blocks$: Observable<PinnedBlocks>,\n  getBody: (block: string) => Observable<string[]>, // Returns an observable that should emit just once and complete\n  getIsValid: (\n    block: string,\n    tx: string,\n  ) => Observable<ResultPayload<any, any>>, // Returns an observable that should emit just once and complete\n  getEvents: (block: string) => Observable<any>, // Returns an observable that should emit just once and complete\n) => {\n  const whileBlockPresent = <TT>(\n    hash: string,\n  ): (<T = TT>(base: Observable<T>) => Observable<T>) =>\n    takeUntil(blocks$.pipe(filter(({ blocks }) => !blocks.has(hash))))\n\n  const analyzeBlock = (\n    hash: string,\n    tx: string,\n    alreadyPresent: boolean,\n  ): Observable<AnalyzedBlock> => {\n    if (alreadyPresent)\n      return of({ hash, found: { type: false, validity: null } })\n\n    const whilePresent = whileBlockPresent(hash)\n    return getBody(hash).pipe(\n      mergeMap((txs) => {\n        const index = txs.indexOf(tx)\n        return index > -1\n          ? whilePresent(getEvents(hash)).pipe(\n              map((events) => ({\n                hash,\n                found: {\n                  type: true as true,\n                  index,\n                  events,\n                },\n              })),\n            )\n          : getIsValid(hash, tx).pipe(\n              map((validity) => ({\n                hash,\n                found: { type: false as false, validity },\n              })),\n            )\n      }),\n      whilePresent,\n    )\n  }\n\n  const findInBranch = (\n    hash: string,\n    tx: string,\n    alreadyPresent: Set<string>,\n  ): Observable<AnalyzedBlock> =>\n    analyzeBlock(hash, tx, alreadyPresent.has(hash)).pipe(\n      mergeMap((analyzed) => {\n        const { found } = analyzed\n        return found.type || found.validity?.success === false\n          ? of(analyzed)\n          : blocks$.pipe(\n              whileBlockPresent(hash),\n              mergeMap((x) => x.blocks.get(hash)!.children),\n              distinct(),\n              mergeMap((hash) => findInBranch(hash, tx, alreadyPresent)),\n            )\n      }),\n    )\n\n  return (tx: string): Observable<AnalyzedBlock> =>\n    blocks$.pipe(\n      take(1),\n      mergeMap((x) => findInBranch(x.finalized, tx, new Set(x.blocks.keys()))),\n    )\n}\n"],"names":["hash"],"mappings":";;AA2BO,MAAM,UAAA,GAAa,CACxB,OAAA,EACA,OAAA,EACA,YAIA,SAAA,KACG;AACH,EAAA,MAAM,oBAAoB,CACxB,IAAA,KAEA,SAAA,CAAU,OAAA,CAAQ,KAAK,MAAA,CAAO,CAAC,EAAE,MAAA,OAAa,CAAC,MAAA,CAAO,IAAI,IAAI,CAAC,CAAC,CAAC,CAAA;AAEnE,EAAA,MAAM,YAAA,GAAe,CACnB,IAAA,EACA,EAAA,EACA,cAAA,KAC8B;AAC9B,IAAA,IAAI,cAAA;AACF,MAAA,OAAO,EAAA,CAAG,EAAE,IAAA,EAAM,KAAA,EAAO,EAAE,MAAM,KAAA,EAAO,QAAA,EAAU,IAAA,EAAK,EAAG,CAAA;AAE5D,IAAA,MAAM,YAAA,GAAe,kBAAkB,IAAI,CAAA;AAC3C,IAAA,OAAO,OAAA,CAAQ,IAAI,CAAA,CAAE,IAAA;AAAA,MACnB,QAAA,CAAS,CAAC,GAAA,KAAQ;AAChB,QAAA,MAAM,KAAA,GAAQ,GAAA,CAAI,OAAA,CAAQ,EAAE,CAAA;AAC5B,QAAA,OAAO,QAAQ,EAAA,GACX,YAAA,CAAa,SAAA,CAAU,IAAI,CAAC,CAAA,CAAE,IAAA;AAAA,UAC5B,GAAA,CAAI,CAAC,MAAA,MAAY;AAAA,YACf,IAAA;AAAA,YACA,KAAA,EAAO;AAAA,cACL,IAAA,EAAM,IAAA;AAAA,cACN,KAAA;AAAA,cACA;AAAA;AACF,WACF,CAAE;AAAA,SACJ,GACA,UAAA,CAAW,IAAA,EAAM,EAAE,CAAA,CAAE,IAAA;AAAA,UACnB,GAAA,CAAI,CAAC,QAAA,MAAc;AAAA,YACjB,IAAA;AAAA,YACA,KAAA,EAAO,EAAE,IAAA,EAAM,KAAA,EAAgB,QAAA;AAAS,WAC1C,CAAE;AAAA,SACJ;AAAA,MACN,CAAC,CAAA;AAAA,MACD;AAAA,KACF;AAAA,EACF,CAAA;AAEA,EAAA,MAAM,YAAA,GAAe,CACnB,IAAA,EACA,EAAA,EACA,cAAA,KAEA,YAAA,CAAa,IAAA,EAAM,EAAA,EAAI,cAAA,CAAe,GAAA,CAAI,IAAI,CAAC,CAAA,CAAE,IAAA;AAAA,IAC/C,QAAA,CAAS,CAAC,QAAA,KAAa;AACrB,MAAA,MAAM,EAAE,OAAM,GAAI,QAAA;AAClB,MAAA,OAAO,KAAA,CAAM,QAAQ,KAAA,CAAM,QAAA,EAAU,YAAY,KAAA,GAC7C,EAAA,CAAG,QAAQ,CAAA,GACX,OAAA,CAAQ,IAAA;AAAA,QACN,kBAAkB,IAAI,CAAA;AAAA,QACtB,QAAA,CAAS,CAAC,CAAA,KAAM,CAAA,CAAE,OAAO,GAAA,CAAI,IAAI,EAAG,QAAQ,CAAA;AAAA,QAC5C,QAAA,EAAS;AAAA,QACT,SAAS,CAACA,KAAAA,KAAS,aAAaA,KAAAA,EAAM,EAAA,EAAI,cAAc,CAAC;AAAA,OAC3D;AAAA,IACN,CAAC;AAAA,GACH;AAEF,EAAA,OAAO,CAAC,OACN,OAAA,CAAQ,IAAA;AAAA,IACN,KAAK,CAAC,CAAA;AAAA,IACN,QAAA,CAAS,CAAC,CAAA,KAAM,YAAA,CAAa,EAAE,SAAA,EAAW,EAAA,EAAI,IAAI,GAAA,CAAI,CAAA,CAAE,MAAA,CAAO,IAAA,EAAM,CAAC,CAAC;AAAA,GACzE;AACJ;;;;"}