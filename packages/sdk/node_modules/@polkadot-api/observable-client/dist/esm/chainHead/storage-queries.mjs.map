{"version":3,"file":"storage-queries.mjs","sources":["../../../src/chainHead/storage-queries.ts"],"sourcesContent":["import {\n  FollowResponse,\n  StorageItemInput,\n  StorageItemResponse,\n} from \"@polkadot-api/substrate-client\"\nimport { Observable, mergeAll } from \"rxjs\"\nimport { getWithRecovery } from \"./enhancers\"\n\nexport const getRecoveralStorage$ = (\n  getFollower: () => FollowResponse,\n  withRecovery: ReturnType<typeof getWithRecovery>[\"withRecovery\"],\n) => {\n  const recoveralStorage$ = (\n    hash: string,\n    queries: Array<StorageItemInput>,\n    childTrie: string | null,\n    isHighPriority: boolean,\n  ): Observable<StorageItemResponse> =>\n    new Observable<StorageItemResponse[] | Observable<StorageItemResponse>>(\n      (observer) =>\n        getFollower().storageSubscription(\n          hash,\n          queries,\n          childTrie ?? null,\n          (items) => {\n            observer.next(items)\n          },\n          (error) => {\n            observer.error(error)\n          },\n          () => {\n            observer.complete()\n          },\n          (nDiscarded) => {\n            // TODO: leave it like this b/c due to a bug on\n            // PolkadotSDK sometimes this value is `undefined`\n            // https://github.com/paritytech/polkadot-sdk/issues/6683\n            if (nDiscarded > 0)\n              observer.next(\n                recoveralStorage$(\n                  hash,\n                  queries.slice(-nDiscarded),\n                  childTrie,\n                  true,\n                ),\n              )\n          },\n        ),\n    ).pipe(mergeAll(), withRecovery(isHighPriority))\n\n  return recoveralStorage$\n}\n"],"names":[],"mappings":";;AAQO,MAAM,oBAAA,GAAuB,CAClC,WAAA,EACA,YAAA,KACG;AACH,EAAA,MAAM,oBAAoB,CACxB,IAAA,EACA,OAAA,EACA,SAAA,EACA,mBAEA,IAAI,UAAA;AAAA,IACF,CAAC,QAAA,KACC,WAAA,EAAY,CAAE,mBAAA;AAAA,MACZ,IAAA;AAAA,MACA,OAAA;AAAA,MACA,SAAA,IAAa,IAAA;AAAA,MACb,CAAC,KAAA,KAAU;AACT,QAAA,QAAA,CAAS,KAAK,KAAK,CAAA;AAAA,MACrB,CAAA;AAAA,MACA,CAAC,KAAA,KAAU;AACT,QAAA,QAAA,CAAS,MAAM,KAAK,CAAA;AAAA,MACtB,CAAA;AAAA,MACA,MAAM;AACJ,QAAA,QAAA,CAAS,QAAA,EAAS;AAAA,MACpB,CAAA;AAAA,MACA,CAAC,UAAA,KAAe;AAId,QAAA,IAAI,UAAA,GAAa,CAAA;AACf,UAAA,QAAA,CAAS,IAAA;AAAA,YACP,iBAAA;AAAA,cACE,IAAA;AAAA,cACA,OAAA,CAAQ,KAAA,CAAM,CAAC,UAAU,CAAA;AAAA,cACzB,SAAA;AAAA,cACA;AAAA;AACF,WACF;AAAA,MACJ;AAAA;AACF,IACF,IAAA,CAAK,QAAA,EAAS,EAAG,YAAA,CAAa,cAAc,CAAC,CAAA;AAEjD,EAAA,OAAO,iBAAA;AACT;;;;"}