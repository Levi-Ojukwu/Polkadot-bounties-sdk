{"version":3,"file":"block-operations.mjs","sources":["../../../../src/chainHead/streams/block-operations.ts"],"sourcesContent":["import { Observable, distinctUntilChanged, map, takeWhile } from \"rxjs\"\nimport { PinnedBlocks } from \"./pinned-blocks\"\n\nexport const isBestOrFinalizedBlock = (\n  blocks$: Observable<PinnedBlocks>,\n  blockHash: string,\n) =>\n  blocks$.pipe(\n    takeWhile((b) => b.blocks.has(blockHash)),\n    distinctUntilChanged(\n      (a, b) => a.finalized === b.finalized && a.best === b.best,\n    ),\n    map((pinned): \"best\" | \"finalized\" | null => {\n      if (\n        pinned.blocks.get(blockHash)!.number >\n        pinned.blocks.get(pinned.best)!.number\n      )\n        return null\n\n      const { number } = pinned.blocks.get(blockHash)!\n      let current = pinned.blocks.get(pinned.best)!\n      let isFinalized = pinned.finalized === current.hash\n      while (current.number > number) {\n        current = pinned.blocks.get(current.parent)!\n        isFinalized = isFinalized || pinned.finalized === current.hash\n      }\n      if (isFinalized) return \"finalized\"\n      return current.hash === blockHash ? \"best\" : null\n    }),\n    distinctUntilChanged(),\n    takeWhile((x) => x !== \"finalized\", true),\n  )\n"],"names":[],"mappings":";;AAGO,MAAM,sBAAA,GAAyB,CACpC,OAAA,EACA,SAAA,KAEA,OAAA,CAAQ,IAAA;AAAA,EACN,UAAU,CAAC,CAAA,KAAM,EAAE,MAAA,CAAO,GAAA,CAAI,SAAS,CAAC,CAAA;AAAA,EACxC,oBAAA;AAAA,IACE,CAAC,GAAG,CAAA,KAAM,CAAA,CAAE,cAAc,CAAA,CAAE,SAAA,IAAa,CAAA,CAAE,IAAA,KAAS,CAAA,CAAE;AAAA,GACxD;AAAA,EACA,GAAA,CAAI,CAAC,MAAA,KAAwC;AAC3C,IAAA,IACE,MAAA,CAAO,MAAA,CAAO,GAAA,CAAI,SAAS,CAAA,CAAG,MAAA,GAC9B,MAAA,CAAO,MAAA,CAAO,GAAA,CAAI,MAAA,CAAO,IAAI,CAAA,CAAG,MAAA;AAEhC,MAAA,OAAO,IAAA;AAET,IAAA,MAAM,EAAE,MAAA,EAAO,GAAI,MAAA,CAAO,MAAA,CAAO,IAAI,SAAS,CAAA;AAC9C,IAAA,IAAI,OAAA,GAAU,MAAA,CAAO,MAAA,CAAO,GAAA,CAAI,OAAO,IAAI,CAAA;AAC3C,IAAA,IAAI,WAAA,GAAc,MAAA,CAAO,SAAA,KAAc,OAAA,CAAQ,IAAA;AAC/C,IAAA,OAAO,OAAA,CAAQ,SAAS,MAAA,EAAQ;AAC9B,MAAA,OAAA,GAAU,MAAA,CAAO,MAAA,CAAO,GAAA,CAAI,OAAA,CAAQ,MAAM,CAAA;AAC1C,MAAA,WAAA,GAAc,WAAA,IAAe,MAAA,CAAO,SAAA,KAAc,OAAA,CAAQ,IAAA;AAAA,IAC5D;AACA,IAAA,IAAI,aAAa,OAAO,WAAA;AACxB,IAAA,OAAO,OAAA,CAAQ,IAAA,KAAS,SAAA,GAAY,MAAA,GAAS,IAAA;AAAA,EAC/C,CAAC,CAAA;AAAA,EACD,oBAAA,EAAqB;AAAA,EACrB,SAAA,CAAU,CAAC,CAAA,KAAM,CAAA,KAAM,aAAa,IAAI;AAC1C;;;;"}