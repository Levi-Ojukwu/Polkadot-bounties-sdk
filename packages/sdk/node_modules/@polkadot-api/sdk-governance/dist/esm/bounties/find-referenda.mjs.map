{"version":3,"file":"find-referenda.mjs","sources":["../../../src/bounties/find-referenda.ts"],"sourcesContent":["import {\n  PolkadotRuntimeOriginCaller,\n  PolkadotRuntimeOriginCallerOriginal,\n} from \"@/referenda/descriptors\"\nimport { OngoingReferendum } from \"@/referenda/sdk-types\"\nimport { keyedMemo } from \"@/util/memo\"\nimport { MultiAddress } from \"./descriptors\"\n\nconst spenderOrigins = [\n  \"Treasurer\",\n  \"SmallSpender\",\n  \"MediumSpender\",\n  \"BigSpender\",\n  \"SmallTipper\",\n  \"BigTipper\",\n]\n\nconst uncachedGetDecodedSpenderReferenda = async <\n  TOrigin extends PolkadotRuntimeOriginCaller,\n>(\n  ongoingReferenda: OngoingReferendum<{ origin: TOrigin }>[],\n) => {\n  const spenderReferenda = ongoingReferenda.filter((ref) => {\n    const origin = ref.origin as PolkadotRuntimeOriginCallerOriginal\n    return (\n      (origin.type === \"Origins\" &&\n        spenderOrigins.includes(origin.value.type)) ||\n      (origin.type === \"system\" && origin.value.type === \"Root\")\n    )\n  })\n  const response = await Promise.all(\n    spenderReferenda.map((referendum) =>\n      referendum.proposal\n        .decodedCall()\n        .then((call) => ({\n          referendum,\n          call,\n        }))\n        .catch((ex) => {\n          console.error(ex)\n          return null\n        }),\n    ),\n  )\n  return response.filter((v) => !!v)\n}\nconst getDecodedSpenderReferenda: typeof uncachedGetDecodedSpenderReferenda =\n  keyedMemo(uncachedGetDecodedSpenderReferenda, new WeakMap())\n\nconst filterApproveCuratorCalls = (calls: any[], bountyId: number) =>\n  calls\n    .filter(\n      (v) =>\n        v?.bounty_id === bountyId &&\n        typeof v.curator === \"object\" &&\n        typeof v.fee === \"bigint\",\n    )\n    .map((v) => ({\n      curator: v.curator as MultiAddress,\n      fee: v.fee as bigint,\n    }))\n\nexport async function findApprovingReferenda<\n  TOrigin extends PolkadotRuntimeOriginCaller,\n>(\n  ongoingReferenda: OngoingReferendum<{ origin: TOrigin }>[],\n  bountyId: number,\n) {\n  const spenderReferenda = await getDecodedSpenderReferenda(ongoingReferenda)\n\n  return spenderReferenda\n    .map(({ call, referendum }) => {\n      const approveWithCuratorCalls = filterApproveCuratorCalls(\n        findCalls(\n          {\n            pallet: \"Bounties\",\n            name: \"approve_bounty_with_curator\",\n          },\n          call,\n        ),\n        bountyId,\n      )\n\n      const approveCalls = findCalls(\n        {\n          pallet: \"Bounties\",\n          name: \"approve_bounty\",\n        },\n        call,\n      ).filter((v) => v?.bounty_id === bountyId)\n\n      const approveThenProposeCalls = approveCalls.length\n        ? filterApproveCuratorCalls(\n            findCalls(\n              {\n                pallet: \"Bounties\",\n                name: \"propose_curator\",\n              },\n              call,\n            ),\n            bountyId,\n          )\n        : []\n\n      if (!(approveCalls.length + approveWithCuratorCalls.length)) return null\n      return {\n        referendum,\n        proposeCuratorCalls: [\n          ...approveWithCuratorCalls,\n          ...approveThenProposeCalls,\n        ],\n      }\n    })\n    .filter((v) => v !== null)\n}\n\nexport async function findProposingCuratorReferenda<\n  TOrigin extends PolkadotRuntimeOriginCaller,\n>(\n  ongoingReferenda: OngoingReferendum<{ origin: TOrigin }>[],\n  bountyId: number,\n) {\n  const spenderReferenda = await getDecodedSpenderReferenda(ongoingReferenda)\n\n  return spenderReferenda\n    .map(({ call, referendum }) => {\n      const proposeCuratorCalls = filterApproveCuratorCalls(\n        findCalls(\n          {\n            pallet: \"Bounties\",\n            name: \"propose_curator\",\n          },\n          call,\n        ),\n        bountyId,\n      )\n      if (!proposeCuratorCalls.length) return null\n      return { referendum, proposeCuratorCalls }\n    })\n    .filter((v) => v !== null)\n}\n\nexport const findCalls = (\n  call: { pallet: string; name: string },\n  obj: any,\n): any[] => {\n  if (typeof obj !== \"object\") return []\n  if (Array.isArray(obj)) {\n    const approves = []\n    for (const item of obj) approves.push(...findCalls(call, item))\n    return approves\n  }\n  if (obj?.type === call.pallet && obj?.value?.type === call.name) {\n    return [obj.value.value]\n  }\n  const approves = []\n  for (const key of Object.keys(obj))\n    approves.push(...findCalls(call, obj[key]))\n  return approves\n}\n"],"names":["approves"],"mappings":"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"}