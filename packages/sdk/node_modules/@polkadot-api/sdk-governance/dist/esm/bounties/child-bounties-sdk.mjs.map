{"version":3,"file":"child-bounties-sdk.mjs","sources":["../../../src/bounties/child-bounties-sdk.ts"],"sourcesContent":["import { keyedMemo } from \"@/util/memo\"\nimport { partitionEntries } from \"@/util/watchEntries\"\nimport { combineKeys, toKeySet } from \"@react-rxjs/utils\"\nimport { Binary, CompatibilityLevel } from \"polkadot-api\"\nimport { combineLatest, distinctUntilChanged, map } from \"rxjs\"\nimport { getChildBountyAccount } from \"./bounty-account\"\nimport { getBountyDescriptions$ } from \"./bounty-descriptions\"\nimport {\n  ChildBountiesSdkTypedApi,\n  ChildBountiesV0Storage,\n  ChildBountiesV1Storage,\n  ChildBountyWithoutDescription,\n} from \"./child-descriptors\"\nimport {\n  ChildBountiesSdk,\n  ChildBounty,\n  GenericChildBounty,\n} from \"./child-sdk-types\"\n\nexport function createChildBountiesSdk(\n  typedApi: ChildBountiesSdkTypedApi,\n): ChildBountiesSdk {\n  const enhanceBounty = (\n    bounty: ChildBountyWithoutDescription,\n    description: string | null,\n    id: number,\n  ): ChildBounty => {\n    const generic: GenericChildBounty = {\n      ...bounty,\n      type: bounty.status.type,\n      id,\n      description,\n      account: getChildBountyAccount(bounty.parent_bounty, id),\n    }\n\n    const idObj = {\n      parent_bounty_id: bounty.parent_bounty,\n      child_bounty_id: id,\n    }\n    switch (generic.status.type) {\n      case \"Added\":\n        return {\n          ...generic,\n          type: \"Added\",\n          proposeCurator(curator, fee) {\n            return typedApi.tx.ChildBounties.propose_curator({\n              ...idObj,\n              curator: {\n                type: \"Id\",\n                value: curator,\n              },\n              fee,\n            })\n          },\n          close() {\n            return typedApi.tx.ChildBounties.close_child_bounty(idObj)\n          },\n        }\n      case \"CuratorProposed\":\n        return {\n          ...generic,\n          ...generic.status.value,\n          type: \"CuratorProposed\",\n          acceptCuratorRole() {\n            return typedApi.tx.ChildBounties.accept_curator(idObj)\n          },\n          unassignCurator() {\n            return typedApi.tx.ChildBounties.unassign_curator(idObj)\n          },\n          close() {\n            return typedApi.tx.ChildBounties.close_child_bounty(idObj)\n          },\n        }\n      case \"Active\":\n        return {\n          ...generic,\n          type: \"Active\",\n          curator: generic.status.value.curator,\n          award(beneficiary) {\n            return typedApi.tx.ChildBounties.award_child_bounty({\n              ...idObj,\n              beneficiary: {\n                type: \"Id\",\n                value: beneficiary,\n              },\n            })\n          },\n          unassignCurator() {\n            return typedApi.tx.ChildBounties.unassign_curator(idObj)\n          },\n          close() {\n            return typedApi.tx.ChildBounties.close_child_bounty(idObj)\n          },\n        }\n      case \"PendingPayout\":\n        return {\n          ...generic,\n          type: \"PendingPayout\",\n          curator: generic.status.value.curator,\n          unlockAt: generic.status.value.unlock_at,\n          beneficiary: generic.status.value.beneficiary,\n          claim() {\n            return typedApi.tx.ChildBounties.claim_child_bounty(idObj)\n          },\n          unassignCurator() {\n            return typedApi.tx.ChildBounties.unassign_curator(idObj)\n          },\n        }\n    }\n    throw new Error(\"Unreachable\")\n  }\n\n  function watchChildBounties(parentId: number) {\n    const [getBountyById$, bountyKeyChanges$] = partitionEntries(\n      typedApi.query.ChildBounties.ChildBounties.watchEntries(parentId),\n    )\n\n    const v0Api = typedApi as ChildBountiesSdkTypedApi<ChildBountiesV0Storage>\n    const v1Api = typedApi as ChildBountiesSdkTypedApi<ChildBountiesV1Storage>\n    const getEntries = async (): Promise<\n      {\n        keyArgs: [Key: number]\n        value: Binary\n      }[]\n    > => {\n      if (\n        await v0Api.query.ChildBounties.ChildBountyDescriptions.isCompatible(\n          CompatibilityLevel.Partial,\n        )\n      ) {\n        return v0Api.query.ChildBounties.ChildBountyDescriptions.getEntries()\n      }\n\n      const result =\n        await v1Api.query.ChildBounties.ChildBountyDescriptionsV1.getEntries(\n          parentId,\n        )\n      return result.map((r) => ({\n        keyArgs: [r.keyArgs[1]],\n        value: r.value,\n      }))\n    }\n    const getValues = async (\n      keys: [number][],\n    ): Promise<(Binary | undefined)[]> => {\n      if (\n        await v0Api.query.ChildBounties.ChildBountyDescriptions.isCompatible(\n          CompatibilityLevel.Partial,\n        )\n      ) {\n        return v0Api.query.ChildBounties.ChildBountyDescriptions.getValues(keys)\n      }\n\n      return v1Api.query.ChildBounties.ChildBountyDescriptionsV1.getValues(\n        keys.map(([key]) => [parentId, key]),\n      )\n    }\n\n    const descriptions$ = getBountyDescriptions$(\n      getEntries,\n      getValues,\n      bountyKeyChanges$,\n    )\n\n    const bountyIds$ = bountyKeyChanges$.pipe(\n      toKeySet(),\n      map((set) => [...set]),\n    )\n\n    const getEnhancedBountyById$ = (id: number) =>\n      combineLatest([\n        getBountyById$(id),\n        descriptions$.pipe(\n          map((r): string | null => r[id] ?? null),\n          distinctUntilChanged(),\n        ),\n      ]).pipe(\n        map(([bounty, description]) => enhanceBounty(bounty, description, id)),\n      )\n\n    return {\n      bounties$: combineKeys(bountyIds$, getEnhancedBountyById$),\n      getBountyById$: getEnhancedBountyById$,\n      bountyIds$,\n    }\n  }\n\n  function getChildBounty(parentId: number, id: number) {\n    const v0Api = typedApi as ChildBountiesSdkTypedApi<ChildBountiesV0Storage>\n    const v1Api = typedApi as ChildBountiesSdkTypedApi<ChildBountiesV1Storage>\n\n    return Promise.all([\n      typedApi.query.ChildBounties.ChildBounties.getValue(parentId, id),\n      v1Api.query.ChildBounties.ChildBountyDescriptionsV1.isCompatible(\n        CompatibilityLevel.Partial,\n      )\n        .then((isCompat) =>\n          isCompat\n            ? v1Api.query.ChildBounties.ChildBountyDescriptionsV1.getValue(\n                parentId,\n                id,\n              )\n            : v0Api.query.ChildBounties.ChildBountyDescriptions.getValue(id),\n        )\n        .then((r) => (r ? r.asText() : null)),\n    ]).then(([bounty, description]) =>\n      bounty ? enhanceBounty(bounty, description, id) : null,\n    )\n  }\n\n  function getChildBounties(parentId: number) {\n    const v0Api = typedApi as ChildBountiesSdkTypedApi<ChildBountiesV0Storage>\n    const v1Api = typedApi as ChildBountiesSdkTypedApi<ChildBountiesV1Storage>\n\n    return Promise.all([\n      typedApi.query.ChildBounties.ChildBounties.getEntries(parentId),\n      v1Api.query.ChildBounties.ChildBountyDescriptionsV1.isCompatible(\n        CompatibilityLevel.Partial,\n      ).then((isCompat) =>\n        isCompat\n          ? v1Api.query.ChildBounties.ChildBountyDescriptionsV1.getEntries(\n              parentId,\n            ).then((r) =>\n              r.map(({ keyArgs, value }) => ({\n                keyArgs: [keyArgs[1]],\n                value,\n              })),\n            )\n          : v0Api.query.ChildBounties.ChildBountyDescriptions.getEntries(),\n      ),\n    ]).then(([entries, descriptions]) => {\n      const descriptionMap = Object.fromEntries(\n        descriptions.map(({ keyArgs, value }) => [keyArgs[0], value.asText()]),\n      )\n\n      return entries\n        .map(({ keyArgs: [, id], value }) => ({ bounty: value, id }))\n        .sort((a, b) => a.id - b.id)\n        .map(({ bounty, id }) =>\n          enhanceBounty(bounty, descriptionMap[id] ?? null, id),\n        )\n    })\n  }\n\n  const watch: typeof watchChildBounties = keyedMemo(\n    watchChildBounties,\n    new Map(),\n  )\n\n  return {\n    watch,\n    getChildBounty,\n    getChildBounties,\n  }\n}\n"],"names":[],"mappings":"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"}