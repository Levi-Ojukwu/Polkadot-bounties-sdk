{"version":3,"file":"utils.mjs","sources":["../../src/utils.ts"],"sourcesContent":["import { ParsedJsonRpcProvider } from \"./parsed\"\n\nexport const jsonObj = <T extends {}>(input: T) => ({\n  jsonrpc: \"2.0\",\n  ...input,\n})\nexport const operationNotification = <T extends {}>(\n  subscription: string,\n  event: string,\n  operationId: string,\n  innerResult: T = {} as T,\n) =>\n  jsonObj({\n    method: \"chainHead_v1_followEvent\",\n    params: {\n      subscription,\n      result: {\n        event,\n        operationId,\n        ...innerResult,\n      },\n    },\n  })\n\nconst requestPrefix = \"__INNER_RQ_DesV\"\nexport const getRequest = (base: ParsedJsonRpcProvider) => {\n  let nextId = 0\n  const onGoingRequests = new Map<string, (ok: boolean, x: any) => void>()\n\n  const listener: <T extends { id: string; result: T; error?: any }>(\n    msg: T,\n  ) => boolean = ({ id, error, result }) => {\n    const callback = onGoingRequests.get(id)\n    if (callback) {\n      onGoingRequests.delete(id)\n      if (error) callback(false, error)\n      else callback(true, result)\n    }\n    return !callback\n  }\n\n  let send: <T extends {}>(msg: T) => void = () => {}\n  const provider: ParsedJsonRpcProvider = (onMsg) => {\n    const { send: _send, disconnect } = base((msg) => {\n      if (listener(msg as any)) onMsg(msg)\n    })\n    send = _send\n    return {\n      send,\n      disconnect: () => {\n        onGoingRequests.clear()\n        disconnect()\n      },\n    }\n  }\n\n  const request = <T>(\n    method: string,\n    params: Array<any>,\n    onSuccess: (x: T) => void,\n    onError: (e: any) => void,\n  ): void => {\n    const id = requestPrefix + nextId++\n    onGoingRequests.set(id, (isOk, value) => {\n      ;(isOk ? onSuccess : onError)(value)\n    })\n    send(jsonObj({ id, method, params }))\n  }\n\n  return [provider, request] as const\n}\n"],"names":[],"mappings":"AAEO,MAAM,OAAA,GAAU,CAAe,KAAA,MAAc;AAAA,EAClD,OAAA,EAAS,KAAA;AAAA,EACT,GAAG;AACL,CAAA;AACO,MAAM,qBAAA,GAAwB,CACnC,YAAA,EACA,KAAA,EACA,aACA,WAAA,GAAiB,OAEjB,OAAA,CAAQ;AAAA,EACN,MAAA,EAAQ,0BAAA;AAAA,EACR,MAAA,EAAQ;AAAA,IACN,YAAA;AAAA,IACA,MAAA,EAAQ;AAAA,MACN,KAAA;AAAA,MACA,WAAA;AAAA,MACA,GAAG;AAAA;AACL;AAEJ,CAAC;AAEH,MAAM,aAAA,GAAgB,iBAAA;AACf,MAAM,UAAA,GAAa,CAAC,IAAA,KAAgC;AACzD,EAAA,IAAI,MAAA,GAAS,CAAA;AACb,EAAA,MAAM,eAAA,uBAAsB,GAAA,EAA2C;AAEvE,EAAA,MAAM,WAES,CAAC,EAAE,EAAA,EAAI,KAAA,EAAO,QAAO,KAAM;AACxC,IAAA,MAAM,QAAA,GAAW,eAAA,CAAgB,GAAA,CAAI,EAAE,CAAA;AACvC,IAAA,IAAI,QAAA,EAAU;AACZ,MAAA,eAAA,CAAgB,OAAO,EAAE,CAAA;AACzB,MAAA,IAAI,KAAA,EAAO,QAAA,CAAS,KAAA,EAAO,KAAK,CAAA;AAAA,WAC3B,QAAA,CAAS,MAAM,MAAM,CAAA;AAAA,IAC5B;AACA,IAAA,OAAO,CAAC,QAAA;AAAA,EACV,CAAA;AAEA,EAAA,IAAI,OAAuC,MAAM;AAAA,EAAC,CAAA;AAClD,EAAA,MAAM,QAAA,GAAkC,CAAC,KAAA,KAAU;AACjD,IAAA,MAAM,EAAE,IAAA,EAAM,KAAA,EAAO,YAAW,GAAI,IAAA,CAAK,CAAC,GAAA,KAAQ;AAChD,MAAA,IAAI,QAAA,CAAS,GAAU,CAAA,EAAG,KAAA,CAAM,GAAG,CAAA;AAAA,IACrC,CAAC,CAAA;AACD,IAAA,IAAA,GAAO,KAAA;AACP,IAAA,OAAO;AAAA,MACL,IAAA;AAAA,MACA,YAAY,MAAM;AAChB,QAAA,eAAA,CAAgB,KAAA,EAAM;AACtB,QAAA,UAAA,EAAW;AAAA,MACb;AAAA,KACF;AAAA,EACF,CAAA;AAEA,EAAA,MAAM,OAAA,GAAU,CACd,MAAA,EACA,MAAA,EACA,WACA,OAAA,KACS;AACT,IAAA,MAAM,KAAK,aAAA,GAAgB,MAAA,EAAA;AAC3B,IAAA,eAAA,CAAgB,GAAA,CAAI,EAAA,EAAI,CAAC,IAAA,EAAM,KAAA,KAAU;AACtC,MAAA,CAAC,IAAA,GAAO,SAAA,GAAY,OAAA,EAAS,KAAK,CAAA;AAAA,IACrC,CAAC,CAAA;AACD,IAAA,IAAA,CAAK,QAAQ,EAAE,EAAA,EAAI,MAAA,EAAQ,MAAA,EAAQ,CAAC,CAAA;AAAA,EACtC,CAAA;AAEA,EAAA,OAAO,CAAC,UAAU,OAAO,CAAA;AAC3B;;;;"}