{"version":3,"file":"node-worker.js","sources":["../../src/node-worker.ts"],"sourcesContent":["import { parentPort } from \"node:worker_threads\"\nimport { AddChainOptions, Chain, Client, ClientOptions, start } from \"smoldot\"\n\nexport type SmoldotOptions = Omit<ClientOptions, \"portToWorker\">\nexport interface StartMsg {\n  type: \"start\"\n  value: SmoldotOptions\n}\nexport interface AddChainMsg {\n  type: \"add-chain\"\n  value: Omit<AddChainOptions, \"potentialRelayChains\"> & {\n    potentialRelayChainIds?: number[]\n  }\n}\nexport interface TerminateMsg {\n  type: \"terminate\"\n}\nexport interface ChainMsg {\n  type: \"chain\"\n  value: {\n    id: number\n  } & (\n    | {\n        type: \"remove\" | \"receive\" | \"receiveIterable\"\n      }\n    | {\n        type: \"send\"\n        value: string\n      }\n  )\n}\nexport type RequestMessage = StartMsg | AddChainMsg | TerminateMsg | ChainMsg\nexport type CorrelatedRequestMessage = { id: number } & RequestMessage\n\nlet smoldot: Client | null = null\n\nlet chainId = 0\nconst chains = new Map<number, Chain>()\n\nparentPort!.on(\"message\", async (msg: CorrelatedRequestMessage) => {\n  if (msg.type === \"start\") {\n    if (smoldot !== null) {\n      throw new Error(\"Can't call start on a client already started\")\n    }\n    smoldot = start(msg.value)\n    return parentPort?.postMessage({\n      id: msg.id,\n    })\n  }\n\n  if (smoldot === null) {\n    throw new Error(\"Smoldot not started\")\n  }\n\n  switch (msg.type) {\n    case \"add-chain\": {\n      const potentialRelayChains = msg.value.potentialRelayChainIds?.map(\n        (id) => {\n          const chain = chains.get(id)\n          if (!chain) throw new Error(\"Can't reference removed chain\")\n          return chain\n        },\n      )\n      const chain = await smoldot.addChain({\n        ...msg.value,\n        potentialRelayChains,\n      })\n      const id = chainId++\n      chains.set(id, chain)\n      parentPort?.postMessage({\n        id: msg.id,\n        value: id,\n      })\n      break\n    }\n    case \"terminate\":\n      await smoldot.terminate()\n      parentPort?.postMessage({\n        id: msg.id,\n      })\n      smoldot = null\n      chains.clear()\n      break\n    case \"chain\":\n      handleChainMessage(msg, msg.id)\n      break\n  }\n})\n\nasync function handleChainMessage(msg: ChainMsg, id: number) {\n  const chain = chains.get(msg.value.id)\n  if (!chain) throw new Error(\"Can't reference removed chain\")\n\n  switch (msg.value.type) {\n    case \"receive\":\n      parentPort?.postMessage({\n        id,\n        value: await chain.nextJsonRpcResponse(),\n      })\n      break\n    case \"receiveIterable\":\n      parentPort?.postMessage({\n        id,\n        value: await chain.jsonRpcResponses.next(),\n      })\n      break\n    case \"send\":\n      chain.sendJsonRpc(msg.value.value)\n      break\n    case \"remove\":\n      chain.remove()\n      chains.delete(msg.value.id)\n      break\n  }\n}\n"],"names":["parentPort","start","id","chain"],"mappings":"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"}