{"version":3,"file":"descendant-values.mjs","sources":["../../../src/upstream/descendant-values.ts"],"sourcesContent":["export const createDescendantValues = (\n  request: <Args extends Array<any>, Payload>(\n    method: string,\n    params: Args,\n    onSuccess: (value: Payload) => void,\n    onError: (e: any) => void,\n  ) => () => void,\n) => {\n  return (\n    rootKey: string,\n    at: string,\n    onValues: (input: Array<[string, string]>) => void,\n    onError: (e: any) => void,\n    onDone: () => void,\n  ): (() => void) => {\n    let isRunning = true\n    let areAllKeysDone = false\n    let onGoingValues = 0\n\n    const _onError = (e: any) => {\n      if (isRunning) {\n        isRunning = false\n        onError(e)\n      }\n    }\n\n    const PAGE_SIZE = 1000\n    const pullKeys = (startAtKey?: string) => {\n      request<[string, number, string | undefined, string], string[]>(\n        \"state_getKeysPaged\",\n        [rootKey, PAGE_SIZE, startAtKey || undefined, at],\n        (result) => {\n          if (!isRunning) return\n          if (result.length > 0) {\n            onGoingValues++\n            request<\n              [string[], string],\n              [{ block: string; changes: Array<[string, string]> }]\n            >(\n              \"state_queryStorageAt\",\n              [result, at],\n              ([{ changes }]) => {\n                if (!isRunning) return\n                onGoingValues--\n                onValues(changes)\n                if (areAllKeysDone && !onGoingValues) onDone()\n              },\n              _onError,\n            )\n          }\n          if (result.length < PAGE_SIZE) {\n            areAllKeysDone = true\n            if (!onGoingValues) onDone()\n          } else pullKeys(result.at(-1))\n        },\n        _onError,\n      )\n    }\n    pullKeys()\n\n    return () => {\n      isRunning = false\n    }\n  }\n}\n"],"names":[],"mappings":"AAAO,MAAM,sBAAA,GAAyB,CACpC,OAAA,KAMG;AACH,EAAA,OAAO,CACL,OAAA,EACA,EAAA,EACA,QAAA,EACA,SACA,MAAA,KACiB;AACjB,IAAA,IAAI,SAAA,GAAY,IAAA;AAChB,IAAA,IAAI,cAAA,GAAiB,KAAA;AACrB,IAAA,IAAI,aAAA,GAAgB,CAAA;AAEpB,IAAA,MAAM,QAAA,GAAW,CAAC,CAAA,KAAW;AAC3B,MAAA,IAAI,SAAA,EAAW;AACb,QAAA,SAAA,GAAY,KAAA;AACZ,QAAA,OAAA,CAAQ,CAAC,CAAA;AAAA,MACX;AAAA,IACF,CAAA;AAEA,IAAA,MAAM,SAAA,GAAY,GAAA;AAClB,IAAA,MAAM,QAAA,GAAW,CAAC,UAAA,KAAwB;AACxC,MAAA,OAAA;AAAA,QACE,oBAAA;AAAA,QACA,CAAC,OAAA,EAAS,SAAA,EAAW,UAAA,IAAc,QAAW,EAAE,CAAA;AAAA,QAChD,CAAC,MAAA,KAAW;AACV,UAAA,IAAI,CAAC,SAAA,EAAW;AAChB,UAAA,IAAI,MAAA,CAAO,SAAS,CAAA,EAAG;AACrB,YAAA,aAAA,EAAA;AACA,YAAA,OAAA;AAAA,cAIE,sBAAA;AAAA,cACA,CAAC,QAAQ,EAAE,CAAA;AAAA,cACX,CAAC,CAAC,EAAE,OAAA,EAAS,CAAA,KAAM;AACjB,gBAAA,IAAI,CAAC,SAAA,EAAW;AAChB,gBAAA,aAAA,EAAA;AACA,gBAAA,QAAA,CAAS,OAAO,CAAA;AAChB,gBAAA,IAAI,cAAA,IAAkB,CAAC,aAAA,EAAe,MAAA,EAAO;AAAA,cAC/C,CAAA;AAAA,cACA;AAAA,aACF;AAAA,UACF;AACA,UAAA,IAAI,MAAA,CAAO,SAAS,SAAA,EAAW;AAC7B,YAAA,cAAA,GAAiB,IAAA;AACjB,YAAA,IAAI,CAAC,eAAe,MAAA,EAAO;AAAA,UAC7B,CAAA,MAAO,QAAA,CAAS,MAAA,CAAO,EAAA,CAAG,EAAE,CAAC,CAAA;AAAA,QAC/B,CAAA;AAAA,QACA;AAAA,OACF;AAAA,IACF,CAAA;AACA,IAAA,QAAA,EAAS;AAET,IAAA,OAAO,MAAM;AACX,MAAA,SAAA,GAAY,KAAA;AAAA,IACd,CAAA;AAAA,EACF,CAAA;AACF;;;;"}