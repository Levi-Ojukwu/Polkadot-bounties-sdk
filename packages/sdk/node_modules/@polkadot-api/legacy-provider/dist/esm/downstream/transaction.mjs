import { createOpaqueToken } from '../utils/create-opaque-token.mjs';
import { catchError, concat, timer, takeUntil, ignoreElements } from 'rxjs';

const transactionMethods = Object.fromEntries(
  ["broadcast", "stop"].map((key) => [key, `transaction_v1_${key}`])
);
const createTransactionFns = (upstream, reply) => {
  return (rId, method, args) => {
    const ongoing = /* @__PURE__ */ new Map();
    if (method === transactionMethods.stop) {
      const [token] = args;
      const sub = ongoing.get(token);
      sub?.unsubscribe();
      ongoing.delete(token);
      reply(rId, null);
    } else if (method === transactionMethods.broadcast) {
      const token = createOpaqueToken();
      ongoing.set(
        token,
        upstream.obsRequest("author_submitExtrinsic", args).pipe(
          catchError((_, source) => concat(timer(5e3), source)),
          takeUntil(
            upstream.finalized$.pipe(
              ignoreElements(),
              catchError(() => {
                ongoing.delete(token);
                return [null];
              })
            )
          )
        ).subscribe()
      );
      reply(rId, token);
    } else {
      throw null;
    }
  };
};

export { createTransactionFns, transactionMethods };
//# sourceMappingURL=transaction.mjs.map
