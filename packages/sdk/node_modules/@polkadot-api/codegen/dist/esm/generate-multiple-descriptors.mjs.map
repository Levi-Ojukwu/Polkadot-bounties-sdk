{"version":3,"file":"generate-multiple-descriptors.mjs","sources":["../../src/generate-multiple-descriptors.ts"],"sourcesContent":["import {\n  getChecksumBuilder,\n  getLookupFn,\n} from \"@polkadot-api/metadata-builders\"\nimport {\n  EntryPoint,\n  mapEntryPointReferences,\n  mapReferences,\n  TypedefNode,\n} from \"@polkadot-api/metadata-compatibility\"\nimport type {\n  HexString,\n  UnifiedMetadata,\n} from \"@polkadot-api/substrate-bindings\"\nimport { mapObject } from \"@polkadot-api/utils\"\nimport {\n  capitalize,\n  DescriptorValues,\n  generateDescriptors,\n} from \"./generate-descriptors\"\nimport { generateTypes } from \"./generate-types\"\nimport { getUsedTypes } from \"./get-used-types\"\nimport { knownTypes, type KnownTypes } from \"./known-types\"\nimport { defaultDeclarations, getTypesBuilder, Variable } from \"./types-builder\"\nimport { applyWhitelist } from \"./whitelist\"\n\nexport const generateMultipleDescriptors = (\n  chains: Array<{\n    key: string\n    metadata: UnifiedMetadata\n    knownTypes: KnownTypes\n    genesis?: HexString\n  }>,\n  paths: {\n    client: string\n    metadataTypes: string\n    types: string\n    descriptorValues: string\n    common: string\n  },\n  options: {\n    whitelist?: string[]\n  } = {},\n) => {\n  const chainData = chains.map((chain) => {\n    const metadata = options.whitelist\n      ? applyWhitelist(chain.metadata, options.whitelist)\n      : chain.metadata\n    const lookup = getLookupFn(metadata)\n    const builder = getChecksumBuilder(lookup)\n    const { checksums, types, entryPoints } = getUsedTypes(lookup, builder)\n    return {\n      ...chain,\n      lookup,\n      builder,\n      checksums,\n      types,\n      entryPoints,\n      knownTypes: {\n        ...knownTypes,\n        ...chain.knownTypes,\n      },\n    }\n  })\n  resolveConflicts(chainData)\n  const types = mergeTypes(chainData)\n\n  const declarations = defaultDeclarations()\n  const chainFiles = chainData.map((chain) =>\n    generateDescriptors(\n      chain.lookup,\n      types.checksumToIdx,\n      getTypesBuilder(\n        declarations,\n        chain.lookup,\n        chain.knownTypes,\n        chain.builder,\n      ),\n      chain.builder,\n      chain.key,\n      paths,\n      chain.genesis,\n    ),\n  )\n\n  const descriptorsFileContent = generateDescriptorValuesContent(\n    Object.fromEntries(\n      chainFiles.map((file, i) => [chainData[i].key, file.descriptorValues]),\n    ),\n  )\n\n  const commonFileContent = `const table = new Uint8Array(128);\nfor (let i = 0; i < 64; i++) table[i < 26 ? i + 65 : i < 52 ? i + 71 : i < 62 ? i - 4 : i * 4 - 205] = i;\nexport const toBinary = (base64: string) => {\n  const n = base64.length,\n    bytes = new Uint8Array((n - Number(base64[n - 1] === '=') - Number(base64[n - 2] === '=')) * 3 / 4 | 0);\n  for (let i2 = 0, j = 0; i2 < n;) {\n    const c0 = table[base64.charCodeAt(i2++)], c1 = table[base64.charCodeAt(i2++)];\n    const c2 = table[base64.charCodeAt(i2++)], c3 = table[base64.charCodeAt(i2++)];\n    bytes[j++] = c0 << 2 | c1 >> 4;\n    bytes[j++] = c1 << 4 | c2 >> 2;\n    bytes[j++] = c2 << 6 | c3;\n  }\n  return bytes;\n}`\n\n  return {\n    commonFileContent,\n    descriptorsFileContent,\n    metadataTypes: types,\n    descriptorTypesFiles: chainFiles.map((file) => ({\n      content: file.descriptorTypes,\n      exports: file.exports,\n    })),\n    typesFileContent: generateTypes(\n      declarations,\n      paths,\n      new Set(chainFiles.map((x) => x.commonTypeImports).flat()),\n    ),\n    publicTypes: getPublicTypes(declarations.variables),\n  }\n}\n\nfunction getPublicTypes(variables: Map<string, Variable>) {\n  return Array.from(variables.values())\n    .filter((variable) => variable.type.startsWith(\"Enum<\"))\n    .map((variable) => variable.name)\n}\n\nfunction resolveConflicts(\n  chainData: Array<{\n    key: string\n    checksums: string[]\n    knownTypes: KnownTypes\n  }>,\n) {\n  // Name => chain => checksum\n  const usedNames = new Map<string, Map<string, Set<string>>>()\n\n  chainData.forEach((chain) =>\n    chain.checksums.forEach((checksum) => {\n      const known = chain.knownTypes[checksum]\n      if (!known) return\n      const { name } = known\n      if (!usedNames.has(name)) {\n        usedNames.set(name, new Map())\n      }\n      if (!usedNames.get(name)!.has(chain.key)) {\n        usedNames.get(name)!.set(chain.key, new Set())\n      }\n      usedNames.get(name)!.get(chain.key)!.add(checksum)\n    }),\n  )\n\n  const conflictedNames = Array.from(usedNames.entries())\n    .filter(([_, chainToChecksums]) => {\n      const checksums = new Set(\n        Array.from(chainToChecksums.values()).flatMap((v) => [...v]),\n      )\n      if (checksums.size === 1) return false\n      const allAreTheSame = Array.from(chainToChecksums.values()).every(\n        (chainChecksums) => chainChecksums.size === checksums.size,\n      )\n      if (allAreTheSame) return false\n      return true\n    })\n    .map(([name]) => name)\n\n  conflictedNames.forEach((name) => {\n    const nameChecksums = Array.from(\n      new Set(\n        Array.from(usedNames.get(name)?.values() ?? []).flatMap((v) =>\n          Array.from(v),\n        ),\n      ),\n    )\n\n    const checksumMaxPriority = nameChecksums.map((checksum) => ({\n      checksum,\n      priority: chainData\n        .map((chain) => chain.knownTypes[checksum]?.priority ?? 0)\n        .reduce((a, b) => Math.max(a, b), 0),\n    }))\n    const absoluteMax = checksumMaxPriority\n      .map((v) => v.priority)\n      .reduce((a, b) => Math.max(a, b), 0)\n    const checksumsLowPriority = checksumMaxPriority.filter(\n      (v) => v.priority !== absoluteMax,\n    )\n\n    const checksumsChangingName =\n      checksumsLowPriority.length === checksumMaxPriority.length - 1\n        ? checksumsLowPriority\n        : checksumMaxPriority\n\n    chainData.forEach((chain) =>\n      checksumsChangingName.forEach(({ checksum }) => {\n        if (!chain.knownTypes[checksum]) return\n        chain.knownTypes[checksum] = {\n          name: capitalize(chain.key) + name,\n          priority: chain.knownTypes[checksum].priority,\n        }\n      }),\n    )\n  })\n}\n\nfunction mergeTypes(\n  chainData: Array<{\n    types: Map<string, TypedefNode>\n    entryPoints: Map<string, EntryPoint>\n    checksums: string[]\n  }>,\n) {\n  const typedefs: Array<[TypedefNode, string[]]> = []\n  const entryPoints: Array<[EntryPoint, string[]]> = []\n  const loookupToTypedefIdx: Map<string, number> = new Map()\n  const checksumToIdx: Map<string, number> = new Map()\n\n  chainData.forEach(({ types, entryPoints: chainEntryPoints, checksums }) => {\n    for (const entry of types.entries()) {\n      const [checksum, value] = entry\n      if (loookupToTypedefIdx.has(checksum)) continue\n      loookupToTypedefIdx.set(checksum, typedefs.length)\n      typedefs.push([value, checksums])\n    }\n    for (const entry of chainEntryPoints.entries()) {\n      const [checksum, value] = entry\n      if (checksumToIdx.has(checksum)) continue\n      checksumToIdx.set(checksum, entryPoints.length)\n      entryPoints.push([value, checksums])\n    }\n  })\n\n  // Update indices to the new one\n  const updatedTypedefs = typedefs.map(([typedef, checksums]) =>\n    mapReferences(typedef, (id) => loookupToTypedefIdx.get(checksums[id])!),\n  )\n  const updatedEntryPoints = entryPoints.map(([entryPoint, checksums]) =>\n    mapEntryPointReferences(\n      entryPoint,\n      (id) => loookupToTypedefIdx.get(checksums[id])!,\n    ),\n  )\n\n  return {\n    typedefs: updatedTypedefs,\n    entryPoints: updatedEntryPoints,\n    checksumToIdx,\n  }\n}\n\nfunction generateDescriptorValuesContent(\n  descriptorValues: Record<string, DescriptorValues>,\n) {\n  const usages: Record<string, number> = {}\n  const countUsages = (obj: Record<string, any>): void =>\n    Object.entries(obj).forEach(([key, value]) => {\n      usages[key] = usages[key] ?? 0\n      usages[key]++\n      if (typeof value === \"object\") countUsages(value)\n    })\n  countUsages(descriptorValues)\n\n  const tokens: Array<string> = []\n  const tokenToIdx: Record<string, number> = {}\n  const minifyKeys = <T extends Record<string | number, any>>(obj: T): T =>\n    Object.fromEntries(\n      Object.entries(obj).map(([key, value]) => {\n        const newValue = typeof value === \"number\" ? value : minifyKeys(value)\n        if (usages[key] <= 1) return [key, newValue]\n        if (!(key in tokenToIdx)) {\n          tokenToIdx[key] = tokens.length\n          tokens.push(key)\n        }\n        return [tokenToIdx[key], newValue]\n      }),\n    ) as T\n  const minified = mapObject(descriptorValues, minifyKeys)\n\n  const getTreeKey = (tree: Record<string, unknown>): string =>\n    Object.entries(tree)\n      .sort(([a], [b]) => a.localeCompare(b))\n      .map(\n        ([key, value]) =>\n          `[${key}:${typeof value === \"object\" ? getTreeKey(value as any) : value}]`,\n      )\n      .join(\"\")\n\n  type Transformed = Record<string, number | Record<string, number>>\n  /**\n   * Modifies in-place, changes type to Transformed.\n   */\n  const findCommonTrees = (\n    values: Array<Record<string, Record<string, unknown>>>,\n  ) => {\n    const treeUsages: Record<string, number> = {}\n    const keys = values.map((obj) =>\n      mapObject(obj, (tree) => {\n        const key = getTreeKey(tree)\n        treeUsages[key] = treeUsages[key] ?? 0\n        treeUsages[key]++\n        return key\n      }),\n    )\n\n    const commonTrees: Array<Record<string, unknown>> = []\n    const keyToCommonTree: Record<string, number> = {}\n    values.forEach((obj, i) =>\n      Object.entries(obj).forEach(([objKey, tree]) => {\n        const key = keys[i][objKey]\n        if (treeUsages[key] > 1) {\n          if (!(key in keyToCommonTree)) {\n            keyToCommonTree[key] = commonTrees.length\n            commonTrees.push(tree)\n          }\n          ;(obj as Transformed)[objKey] = keyToCommonTree[key]\n        }\n      }),\n    )\n\n    return commonTrees\n  }\n\n  const commonTrees = findCommonTrees(\n    Object.keys(Object.values(minified)[0]).flatMap((type) =>\n      Object.values(minified).map((d) => d[type as keyof DescriptorValues]),\n    ),\n  )\n\n  const data = JSON.stringify([minified, commonTrees, tokens])\n\n  return `\n    const [minified, commonTrees, tokens] = JSON.parse(\\`${data}\\`);\n\n    const replaceTokens = <T>(obj: Record<string | number, T>): Record<string, T> =>\n      Object.fromEntries(\n        Object.entries(obj).map(([key, value]) => {\n          const unwrappedValue =\n            typeof value === \"object\" ? replaceTokens(value as any) : value\n          const numericKey = Number(key)\n          if (Number.isNaN(numericKey)) {\n            return [key, unwrappedValue]\n          }\n          return [tokens[numericKey], unwrappedValue]\n        }),\n      ) as Record<string, T>\n    const tokenizedCommonTrees = commonTrees.map(replaceTokens)\n\n    const unwrap = (\n      obj: Record<string, object | number>,\n      depth: number,\n    ): Record<string, object> =>\n      depth === 0\n        ? (obj as Record<string, object>)\n        : Object.fromEntries(\n            Object.entries(obj).map(([key, value]) => [\n              key,\n              unwrap(\n                typeof value === \"object\" ? value : tokenizedCommonTrees[value],\n                depth - 1,\n              ),\n            ]),\n          )\n\n    const getChainDescriptors = (key: string) =>\n      unwrap(replaceTokens(minified[key]), 2)\n\n    ${Object.keys(descriptorValues)\n      .map(\n        (key) =>\n          `export const ${capitalize(key)} = getChainDescriptors(\"${key}\")`,\n      )\n      .join(\"\\n\")}\n  `\n}\n"],"names":["types","commonTrees"],"mappings":"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"}