{"version":3,"file":"event.mjs","sources":["../../src/event.ts"],"sourcesContent":["import { Observable, firstValueFrom, map, mergeMap } from \"rxjs\"\nimport { BlockInfo, ChainHead$ } from \"@polkadot-api/observable-client\"\nimport { CompatibilityFunctions, CompatibilityHelper } from \"./compatibility\"\nimport { concatMapEager, shareLatest } from \"./utils\"\n\nexport type EventPhase =\n  | { type: \"ApplyExtrinsic\"; value: number }\n  | { type: \"Finalization\" }\n  | { type: \"Initialization\" }\n\nexport type EvWatch<T> = (filter?: (value: T) => boolean) => Observable<{\n  meta: {\n    block: BlockInfo\n    phase: EventPhase\n  }\n  payload: T\n}>\n\nexport type EvPull<T> = () => Promise<\n  Array<{\n    meta: {\n      block: BlockInfo\n      phase: EventPhase\n    }\n    payload: T\n  }>\n>\n\nexport type EvFilter<T> = (collection: SystemEvent[\"event\"][]) => Array<T>\n\nexport type EvClient<Unsafe, D, T> = {\n  /**\n   * Multicast and stateful Observable watching for new events (matching the\n   * event kind chosen) in the latest known `finalized` block.\n   *\n   * @param filter  Optional filter function to only emit events complying\n   *                with the function.\n   */\n  watch: EvWatch<T>\n  /**\n   * Fetch (Promise-based) all events (matching the event kind chosen) available\n   * in the latest known `finalized` block.\n   */\n  pull: EvPull<T>\n  /**\n   * Filter a bunch of `SystemEvent` and return the decoded `payload` of every\n   * of them.\n   *\n   * @param collection  Array of `SystemEvent` to filter.\n   */\n  filter: EvFilter<T>\n} & (Unsafe extends true ? {} : CompatibilityFunctions<D>)\n\ntype SystemEvent = {\n  phase: EventPhase\n  event: {\n    type: string\n    value: {\n      type: string\n      value: any\n    }\n  }\n  topics: Array<any>\n}\n\nexport const createEventEntry = <D, T>(\n  pallet: string,\n  name: string,\n  chainHead: ChainHead$,\n  {\n    isCompatible,\n    getCompatibilityLevel,\n    withCompatibleRuntime,\n    argsAreCompatible,\n    valuesAreCompatible,\n  }: CompatibilityHelper,\n): EvClient<any, D, T> => {\n  const compatibilityError = () =>\n    new Error(`Incompatible runtime entry Event(${pallet}.${name})`)\n\n  const shared$ = chainHead.finalized$.pipe(\n    withCompatibleRuntime(chainHead, (x) => x.hash),\n    map(([block, runtime, ctx]) => {\n      const eventsIdx = ctx.lookup.metadata.pallets.find(\n        (p) => p.name === pallet,\n      )?.events?.type\n      if (\n        eventsIdx == null ||\n        ctx.lookup.metadata.lookup[eventsIdx].def.tag !== \"variant\" ||\n        ctx.lookup.metadata.lookup[eventsIdx].def.value.find(\n          (ev) => ev.name === name,\n        ) == null\n      )\n        throw new Error(`Runtime entry Event(${pallet}.${name}) not found`)\n\n      if (!argsAreCompatible(runtime, ctx, null)) throw compatibilityError()\n      return [block, runtime, ctx] as const\n    }),\n    concatMapEager(([block, runtime, ctx]) =>\n      chainHead.eventsAt$(block.hash).pipe(\n        map((events) => {\n          const winners = events.filter(\n            (e) => e.event.type === pallet && e.event.value.type === name,\n          )\n          return winners.map((x) => {\n            if (!valuesAreCompatible(runtime, ctx, x.event.value.value))\n              throw compatibilityError()\n            return {\n              meta: {\n                phase: x.phase,\n                block,\n              },\n              payload: x.event.value.value,\n            }\n          })\n        }),\n      ),\n    ),\n    shareLatest,\n  )\n\n  const watch: EvWatch<T> = (f) =>\n    shared$.pipe(mergeMap((x) => (f ? x.filter((d) => f(d.payload)) : x)))\n\n  const pull: EvPull<T> = () => firstValueFrom(shared$)\n\n  const filter: EvFilter<T> = (events) =>\n    events\n      .filter((e) => e.type === pallet && e.value.type === name)\n      .map((x) => x.value.value)\n\n  return { watch, pull, filter, getCompatibilityLevel, isCompatible }\n}\n"],"names":[],"mappings":"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"}