{"version":3,"file":"sign-extensions.mjs","sources":["../../../../src/tx/signed-extensions/sign-extensions.ts"],"sourcesContent":["import {\n  getDynamicBuilder,\n  MetadataLookup,\n} from \"@polkadot-api/metadata-builders\"\nimport { Encoder } from \"@polkadot-api/substrate-bindings\"\nimport { OfflineTxExtensions } from \"../types\"\nimport { fromHex, mapObject } from \"@polkadot-api/utils\"\nimport { getSystemVersionStruct } from \"./system-version\"\nimport { mortal } from \"./mortal-enc\"\nimport { ChargeAssetTxPaymentEnc } from \"./charge-asset-tx-enc\"\n\nconst empty = new Uint8Array()\nconst zero = Uint8Array.from([0])\ntype DynamicBuilder = ReturnType<typeof getDynamicBuilder>\n\nconst value = (value: Uint8Array) => ({\n  value,\n  additionalSigned: empty,\n})\nconst additionalSigned = (additionalSigned: Uint8Array) => ({\n  value: empty,\n  additionalSigned,\n})\nconst both = (value: Uint8Array, additionalSigned: Uint8Array) => ({\n  value,\n  additionalSigned,\n})\n\nexport const getSignExtensionsCreator = (\n  genesis: Uint8Array,\n  lookupFn: MetadataLookup,\n  dynamicBuilder: DynamicBuilder,\n) => {\n  const signedExtensionsEncoders: Record<string, [Encoder<any>, Encoder<any>]> =\n    {}\n  lookupFn.metadata.extrinsic.signedExtensions.forEach(\n    ({ identifier, type, additionalSigned }) => {\n      signedExtensionsEncoders[identifier] = [type, additionalSigned].map(\n        (x) => dynamicBuilder.buildDefinition(x)[0],\n      ) as [Encoder<any>, Encoder<any>]\n    },\n  )\n\n  return <Asset>({\n    mortality,\n    tip = 0n,\n    nonce,\n    customSignedExtensions = {},\n    ...rest\n  }: OfflineTxExtensions<Asset>): Record<\n    string,\n    { identifier: string; value: Uint8Array; additionalSigned: Uint8Array }\n  > => {\n    const invalidKeys: string[] = []\n    const systemVersion = getSystemVersionStruct(lookupFn, dynamicBuilder)\n    const getFromCustomEntry = (key: string) => {\n      const [valueEnc, additionalEnc] = signedExtensionsEncoders[key]\n      const customEntry = customSignedExtensions[key] as any\n      try {\n        return mapObject(\n          {\n            value: valueEnc,\n            additionalSigned: additionalEnc,\n          },\n          (encoder, key) => {\n            const input = customEntry?.[key]\n            // if the encoder is _void, then the input value is ignored, so no harm in passing `undefined`\n            // only an `Option` encoder will accept `undefined` as an input without crashing\n            return input instanceof Uint8Array ? input : encoder(input)\n          },\n        )\n      } catch {\n        // this means that a non optional custom signed-extension has not received its value\n        invalidKeys.push(key)\n        return null\n      }\n    }\n\n    const result = mapObject(\n      signedExtensionsEncoders,\n      ([valueEnc, additionalEnc], key) => {\n        if (customSignedExtensions[key]) return getFromCustomEntry(key)\n\n        switch (key) {\n          case \"CheckNonce\":\n            return value(valueEnc(nonce))\n\n          case \"CheckMortality\":\n            return mortality.mortal\n              ? both(\n                  mortal({\n                    period: mortality.period,\n                    startAtBlock: mortality.startAtBlock.height,\n                  }),\n                  fromHex(mortality.startAtBlock.hash),\n                )\n              : both(zero, genesis)\n\n          case \"ChargeTransactionPayment\":\n            return value(valueEnc(tip))\n\n          case \"ChargeAssetTxPayment\":\n            return value(\n              ChargeAssetTxPaymentEnc({\n                tip,\n                asset: (rest as any).asset,\n              }),\n            )\n\n          case \"CheckGenesis\":\n            return additionalSigned(genesis)\n\n          case \"CheckMetadataHash\":\n            return both(zero, zero)\n\n          case \"CheckSpecVersion\":\n            return additionalSigned(\n              additionalEnc(systemVersion[\"spec_version\"]),\n            )\n\n          case \"CheckTxVersion\":\n            return additionalSigned(\n              additionalEnc(systemVersion[\"transaction_version\"]),\n            )\n\n          default:\n            return getFromCustomEntry(key)\n        }\n      },\n    )\n\n    invalidKeys.forEach((key) => {\n      delete result[key]\n    })\n    return mapObject(result, (x, identifier) => ({ ...x, identifier })) as any\n  }\n}\n"],"names":["value","additionalSigned","key"],"mappings":"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"}