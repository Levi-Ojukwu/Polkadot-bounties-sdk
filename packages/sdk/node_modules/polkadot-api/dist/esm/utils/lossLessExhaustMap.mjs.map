{"version":3,"file":"lossLessExhaustMap.mjs","sources":["../../../src/utils/lossLessExhaustMap.ts"],"sourcesContent":["import { Observable, Subscription } from \"rxjs\"\n\nconst EMPTY_VALUE = Symbol(\"EMPTY_VALUE\")\ntype EMPTY_VALUE = typeof EMPTY_VALUE\n\nexport const lossLessExhaustMap =\n  <I, O>(mapper: (x: I, idx: number) => Observable<O>) =>\n  (source$: Observable<I>): Observable<O> =>\n    new Observable((observer) => {\n      let idx = 0\n      let innerSubscription: Subscription | null = null\n      let queuedValue: I | EMPTY_VALUE = EMPTY_VALUE\n      let isOutterDone = false\n\n      const setInnerSubscription = () => {\n        const observable = mapper(queuedValue as I, idx++)\n        queuedValue = EMPTY_VALUE\n        innerSubscription = observable.subscribe({\n          next(vv) {\n            observer.next(vv)\n          },\n          error(ee) {\n            observer.error(ee)\n          },\n          complete() {\n            if (queuedValue !== EMPTY_VALUE) setInnerSubscription()\n            else {\n              innerSubscription = null\n              if (isOutterDone) observer.complete()\n            }\n          },\n        })\n      }\n\n      const subscription = source$.subscribe({\n        next(v) {\n          queuedValue = v\n          if (!innerSubscription) setInnerSubscription()\n        },\n        error(e) {\n          observer.error(e)\n        },\n        complete() {\n          if (!innerSubscription) observer.complete()\n          isOutterDone = true\n        },\n      })\n\n      return () => {\n        innerSubscription?.unsubscribe()\n        subscription.unsubscribe()\n      }\n    })\n"],"names":[],"mappings":";;AAEA,MAAM,WAAA,GAAc,OAAO,aAAa,CAAA;AAGjC,MAAM,kBAAA,GACX,CAAO,MAAA,KACP,CAAC,YACC,IAAI,UAAA,CAAW,CAAC,QAAA,KAAa;AAC3B,EAAA,IAAI,GAAA,GAAM,CAAA;AACV,EAAA,IAAI,iBAAA,GAAyC,IAAA;AAC7C,EAAA,IAAI,WAAA,GAA+B,WAAA;AACnC,EAAA,IAAI,YAAA,GAAe,KAAA;AAEnB,EAAA,MAAM,uBAAuB,MAAM;AACjC,IAAA,MAAM,UAAA,GAAa,MAAA,CAAO,WAAA,EAAkB,GAAA,EAAK,CAAA;AACjD,IAAA,WAAA,GAAc,WAAA;AACd,IAAA,iBAAA,GAAoB,WAAW,SAAA,CAAU;AAAA,MACvC,KAAK,EAAA,EAAI;AACP,QAAA,QAAA,CAAS,KAAK,EAAE,CAAA;AAAA,MAClB,CAAA;AAAA,MACA,MAAM,EAAA,EAAI;AACR,QAAA,QAAA,CAAS,MAAM,EAAE,CAAA;AAAA,MACnB,CAAA;AAAA,MACA,QAAA,GAAW;AACT,QAAA,IAAI,WAAA,KAAgB,aAAa,oBAAA,EAAqB;AAAA,aACjD;AACH,UAAA,iBAAA,GAAoB,IAAA;AACpB,UAAA,IAAI,YAAA,WAAuB,QAAA,EAAS;AAAA,QACtC;AAAA,MACF;AAAA,KACD,CAAA;AAAA,EACH,CAAA;AAEA,EAAA,MAAM,YAAA,GAAe,QAAQ,SAAA,CAAU;AAAA,IACrC,KAAK,CAAA,EAAG;AACN,MAAA,WAAA,GAAc,CAAA;AACd,MAAA,IAAI,CAAC,mBAAmB,oBAAA,EAAqB;AAAA,IAC/C,CAAA;AAAA,IACA,MAAM,CAAA,EAAG;AACP,MAAA,QAAA,CAAS,MAAM,CAAC,CAAA;AAAA,IAClB,CAAA;AAAA,IACA,QAAA,GAAW;AACT,MAAA,IAAI,CAAC,iBAAA,EAAmB,QAAA,CAAS,QAAA,EAAS;AAC1C,MAAA,YAAA,GAAe,IAAA;AAAA,IACjB;AAAA,GACD,CAAA;AAED,EAAA,OAAO,MAAM;AACX,IAAA,iBAAA,EAAmB,WAAA,EAAY;AAC/B,IAAA,YAAA,CAAa,WAAA,EAAY;AAAA,EAC3B,CAAA;AACF,CAAC;;;;"}