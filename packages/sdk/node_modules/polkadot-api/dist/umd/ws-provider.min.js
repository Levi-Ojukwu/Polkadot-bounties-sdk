(function(C,i){typeof exports=="object"&&typeof module<"u"?i(exports):typeof define=="function"&&define.amd?define(["exports"],i):(C=typeof globalThis<"u"?globalThis:C||self,i(C.papiWsProvider={}))})(this,(function(C){"use strict";var i=(t=>(t[t.CONNECTING=0]="CONNECTING",t[t.CONNECTED=1]="CONNECTED",t[t.ERROR=2]="ERROR",t[t.CLOSE=3]="CLOSE",t))(i||{});const _=t=>JSON.stringify({jsonrpc:"2.0",...t}),M=new Set(["v1","unstable"].map(t=>`chainHead_${t}_unfollow`)),$=t=>{let e={type:1,pending:[]};const s=n=>{if(e.type===0){const o=JSON.parse(n);if("id"in o)"result"in o&&e.onGoingRequests.get(o.id)?.type===0&&e.activeChainHeads.add(o.result),e.onGoingRequests.delete(o.id);else if("params"in o){const{subscription:l,result:u}=o.params;u?.event==="stop"&&e.activeChainHeads.delete(l)}}e.type!==2&&t(n)},r=n=>{if(e.type===2)return;if(e.type===1){e.pending.push(n);return}const o=JSON.parse(n);if(M.has(o.method)&&e.activeChainHeads.delete(o.params[0]),"id"in o){const{method:l,id:u}=o,d=l.startsWith("chainHead")?l.endsWith("follow")?{type:0,msg:n}:{type:1,id:u}:{type:2,msg:n};e.onGoingRequests.set(u,d)}e.connection.send(n)};return{send:r,disconnect:()=>{e.type!==2&&(e.type===0&&e.connection.disconnect(),e={type:2})},connect:n=>{if(e.type!==1)throw new Error("Nonesense");const{pending:o}=e,l=new Map,u=new Set;e={type:0,connection:n(s,()=>{e={type:1,pending:[]},u.forEach(h=>{s(_({params:{subscription:h,result:{event:"stop",internal:!0}}}))}),u.clear();for(const h of l.values())h.type===1?s(_({id:h.id,error:{code:-32603,message:"Internal error"},internal:!0})):r(h.msg);l.clear()}),onGoingRequests:l,activeChainHeads:u},o.forEach(r)}}},k=t=>e=>{let s=$(e);const r=()=>{t().then(n=>{if(s)s.connect((o,l)=>n(o,()=>{l(),r()}));else try{n(()=>{},()=>{}).disconnect()}catch{}},()=>{s&&setTimeout(r,0)})};return r(),{send:n=>{s?.send(n)},disconnect:()=>{s?.disconnect(),s=null}}},H={};["v1","unstable"].forEach(t=>{H[`chainHead_${t}_follow`]="follow",H[`chainHead_${t}_unfollow`]="unfollow"});const q=(t,e)=>{const s=new Set,r=new Map,n=new Set;let o;return Object.assign(u=>{const{send:d,disconnect:h}=t(p=>{const f=JSON.parse(p);if("id"in f){const{id:c,result:E}=f;if(c===o&&(o=void 0,E&&!E.methods.some(m=>{const[a,,N]=m.split("_");return a==="chainHead"&&N==="follow"}))){u(p),e();return}const y=r.get(c);if(y){if(r.delete(c),s.has(E)){s.delete(E);return}n.add(E);const m=n.size+r.size;if(m>2)console.warn(`Too many chainHead follow subscriptions (${m})`);else if(f.error){console.warn(`chainHead follow failed on the ${m} sub`),e(),r.set(c,y),d(y);return}}}else{const{subscription:c,result:E}=f.params;E?.event==="stop"&&(n.has(c)?n.delete(c):s.add(c))}u(p)});return{send(p){const f=JSON.parse(p);f.method==="rpc_methods"&&(o=f.id);const c=H[f.method];c==="follow"?r.set(f.id,p):c==="unfollow"&&n.delete(f.params[0]),d(p)},disconnect:h}},{cleanup:()=>{s.clear(),r.clear(),n.clear()}})},G={type:i.ERROR,event:{type:"timeout"}},S=()=>{},J={onStatusChanged:S,innerEnhancer:t=>t,timeout:5e3},j=t=>t.map(e=>typeof e=="string"?[e]:[e.uri,e.protocol]),x=(t,e)=>{const{onStatusChanged:s,innerEnhancer:r,timeout:n}={...J,...e},o=j(Array.isArray(t)?t:[t]),l=e?.websocketClass??globalThis.WebSocket;if(!l)throw new Error("Missing WebSocket class");let u=0,d,h=null,p=S,f=S;const c=q(k(async()=>{const[y,m]=h||o[u++%t.length];h=null;const a=new l(y,m),N=()=>{try{a.addEventListener("error",S,{once:!0}),a.close()}catch{}};s(d={type:i.CONNECTING,uri:y,protocols:m}),await new Promise((L,v)=>{const T=()=>{R(),L()},O=g=>{R(),g==null&&N(),console.error(`Unable to connect to ${y}${m?", protocols: "+m:""}`),s(d={type:g?i.ERROR:i.CLOSE,event:g}),setTimeout(v,g?300:0,g)},b=n!==1/0?setTimeout(()=>{R(),N(),s(d=G),v(G.event)},n):void 0,R=()=>{clearTimeout(b),a.removeEventListener("error",O),a.removeEventListener("open",T)};a.addEventListener("open",T),a.addEventListener("error",O),p=()=>{O(null)}}),s(d={type:i.CONNECTED,uri:y,protocols:m});let I;const z=r(L=>(I=L,{send:v=>{a.send(v)},disconnect:()=>{p()}}));return(L,v)=>{const T=z(L),O=w=>{typeof w.data=="string"&&I(w.data)},b=w=>P=>{console.warn(`WS halt (${w})`),s(d={type:w,event:P}),v()},R=b(i.ERROR),g=b(i.CLOSE);return a.addEventListener("message",O),a.addEventListener("error",R),a.addEventListener("close",g),p=w=>{f(),p=S,a.removeEventListener("message",O),a.removeEventListener("error",R),a.removeEventListener("close",g),N(),w&&g({})},T}}),()=>{E()});f=c.cleanup,delete c.cleanup;const E=(...y)=>{d.type!==i.CLOSE&&(y.length&&(h=y),d.type!==i.ERROR&&p(!0))};return Object.assign(c,{switch:E,getStatus:()=>d})};C.WsEvent=i,C.getWsProvider=x}));
